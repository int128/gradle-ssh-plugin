
remotes {
    gw1 {
        host = 'localhost'
        user = System.properties['user.name']
        identity = file("${System.properties['user.home']}/.ssh/id_rsa")
    }
    gw2 {
        host = 'localhost'
        user = System.properties['user.name']
        identity = file("${System.properties['user.home']}/.ssh/id_rsa")
        gateway = remotes.gw1
        knownHosts = allowAnyHosts
    }
    viaGateway {
        host = 'localhost'
        user = System.properties['user.name']
        identity = file("${System.properties['user.home']}/.ssh/id_rsa")
        gateway = remotes.gw2
        knownHosts = allowAnyHosts
    }
}

feature('connect via a gateway host') {
    task 'connectViaGateway'
    category 'test'
}

task connectViaGateway(type: SshTask) {
    doFirst {
        ext.x = randomInt()
        ext.y = randomInt()
    }
    session(remotes.viaGateway) {
        ext.a = execute "expr $x + $y"
    }
    doLast {
        assert a as int == (x + y)
    }
}
